!function(t){var i={};function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var n in t)e.d(s,n,function(i){return t[i]}.bind(null,n));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=6)}([function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.createId=function(t=""){function i(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return t+(i()+i()+"-")+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()},i.wait=function(t=1e3){return new Promise(i=>{setTimeout(()=>{i()},t)})},i.createCanvas=(t,i,e)=>{const s=window.document.createElement("canvas");return s.id=t,s.width=i,s.height=e,s}},,function(t,i,e){"use strict";var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(i,"__esModule",{value:!0});const n=s(e(7)),a=s(e(9)),o=e(12),r=e(0),l=32,h={type:"scroll",lifeTime:200},c={fontSize:36,fontColor:"#fff",fontFamily:"Microsoft YaHei",avatarSize:50,type:"text",padding:[12,12,12,12],radius:20};i.default=class{constructor(t,i={}){this.resize=()=>{const t=this.calcData(),{containerHeight:i,containerWidth:e}=t;this.globalConfig.canvas.width=e,this.globalConfig.canvas.height=i,this.globalConfig.templateCanvas.width=e,this.globalConfig.templateCanvas.height=i,this.scene.resetGlobalConfig(t)},this.globalConfig=o.mixConfig(i,h),this.container=t,this.globalConfig.canvas=this.initCanvas(!0),this.globalConfig.templateCanvas=this.initCanvas(),this.globalConfig.templateCtx=this.globalConfig.templateCanvas.getContext("2d"),this.globalConfig.ctx=this.globalConfig.canvas.getContext("2d"),this.globalConfig=Object.assign(Object.assign({},this.globalConfig),this.calcData()),this.scene=new n.default(this.globalConfig),this.stop=this.scene.stop.bind(this.scene),this.start=this.scene.start.bind(this.scene),this.clear=this.scene.clear.bind(this.scene),window.addEventListener("resize",this.resize)}add(t){(t=o.mixConfig(t,c)).fontColor||(t.fontColor=o.getRandomColor()),this.scene.add(new a.default(t,this.globalConfig))}destroy(){this.scene.destroy(),window.removeEventListener("resize",this.resize)}initCanvas(t=!1){const{offsetWidth:i,offsetHeight:e}=this.container,s=r.createCanvas("canvas-huiyidun",i,e);return t&&(s.style.position="absolute",s.style.display="block",this.container.append(s)),s}calcData(){const{offsetWidth:t,offsetHeight:i}=this.container;return{containerHeight:i,containerWidth:t,trackRange:[l,i-l]}}}},,,,function(t,i,e){"use strict";e.r(i);var s=e(2),n=e.n(s);window.barrage=new n.a(document.getElementById("webgl"),{type:"scroll"});let a=0;window.add=()=>{window.timer=setInterval(()=>{window.barrage.add({content:"李四：你好呀 🤘🏻111",avatar:"http://thirdwx.qlogo.cn/mmopen/vi_32/JqfbL9Z2prhybabOMfPUELUQAichrtTLCWFCUr6hTicMCE77qwSPsHm7wRNpzPY2kdG3RrlLco6shVAiatGtsIDgw/132"}),(a+=1)>500&&clearInterval(window.time)},100)}},function(t,i,e){"use strict";var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(i,"__esModule",{value:!0});const n=s(e(8));i.default=class{constructor(t){this.timer=null,this.spriteInstances={},this.needAddSpriteList=[],this.run=()=>{this.tryToAddSprite(),this.render(),this.timer=window.requestAnimationFrame(this.run)},this.globalConfig=t,this.trackManger=new n.default(t),this.start()}calcAnimation(t,i=12){const[e]=t;if("reversescroll"===this.globalConfig.type){return{position:[-e,i],speed:[(this.globalConfig.containerWidth+e)/this.globalConfig.lifeTime,0],rangeWidth:[-e,this.globalConfig.containerWidth+e]}}const s=-(this.globalConfig.containerWidth+e)/this.globalConfig.lifeTime;return{position:[this.globalConfig.containerWidth,i],speed:[s,0],rangeWidth:[-e,this.globalConfig.containerWidth]}}add(t){this.needAddSpriteList.push(t)}addSprite(t,i){t.setAnimation(this.calcAnimation(t.size,i)),this.spriteInstances[t.id]=t}tryToAddSprite(){if(0===this.needAddSpriteList.length)return;const[t]=this.needAddSpriteList,i=this.trackManger.applyPosition(t);i&&(this.addSprite(t,i),this.needAddSpriteList.shift())}resetGlobalConfig(t){this.globalConfig=Object.assign(Object.assign({},this.globalConfig),t)}start(){this.timer||this.run()}stop(){this.timer&&(window.cancelAnimationFrame(this.timer),this.timer=null)}clear(){this.spriteInstances={}}destroy(){this.stop(),this.clear()}drawTemplateCanvas(){this.globalConfig.templateCtx.clearRect(0,0,this.globalConfig.containerWidth,this.globalConfig.containerHeight),Object.keys(this.spriteInstances).forEach(t=>{try{const i=this.spriteInstances[t];i.animation(),this.trackManger.removeEmployWithNotEmploy(i),i.status?i.render(this.globalConfig.templateCtx):delete this.spriteInstances[t]}catch(t){}})}render(){this.drawTemplateCanvas(),this.globalConfig.ctx.clearRect(0,0,this.globalConfig.containerWidth,this.globalConfig.containerHeight),this.globalConfig.ctx.drawImage(this.globalConfig.templateCanvas,0,0)}}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=20;i.default=class{constructor(t){this.employTrack={},this.globalConfig=t}getCanUseTrack(t,i,e){const n=[];if(0!==t.length){const e=t.map(t=>t.split(",").map(t=>parseFloat(t))).sort((t,i)=>t[0]>i[0]?1:-1),a=[];e.forEach((t,i)=>{if(0===i)return void a.push(t);const e=a[a.length-1],[n,o]=t;e[1]+s>n?e[1]=o:a.push(t)});const[o]=a[0],[,r]=a[a.length-1];if(i[0]<o&&n.push([i[0],o]),i[1]>r&&n.push([r,i[1]]),a.length>1){let t;a.forEach(i=>{void 0===t?t=i[1]:(n.push([t,i[0]]),t=i[0])})}}else n.push([...i]);for(let t=0;t<n.length;t+=1){const i=n[t];if(i[1]-i[0]>e+s)return[i[0],i[0]+e+s]}return null}applyPosition(t){const i=Object.values(this.employTrack),[,e]=t.size,s=this.getCanUseTrack(i,this.globalConfig.trackRange,e);return s?(this.employTrack[t.id]=s.toString(),t.employTrack=!0,s[0]):null}removeEmployWithNotEmploy(t){!t.employTrack&&this.employTrack[t.id]&&delete this.employTrack[t.id]}}},function(t,i,e){"use strict";var s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(i,"__esModule",{value:!0});const n=s(e(10)),a=s(e(11)),o=e(0),r=20;i.default=class{constructor(t,i){this.status=!0,this.position=null,this.speed=[1,1],this.employTrack=!1,this.getImageData=()=>{this.templateCtx=this.templateCanvas.getContext("2d"),this.templateCtx.clearRect(0,0,this.size[0],this.size[1]),this.drawManager.draw(this.templateCtx,{avatarImage:this.avatarImage,size:this.size})},this.id=o.createId("s-"),this.spriteConfig=t,this.globalConfig=i,this.drawManager=new a.default(t,i),this.size=this.drawManager.calcSize(),this.templateCanvas=o.createCanvas(this.id,this.size[0],this.size[1]),this.spriteConfig.avatar&&n.default(this.spriteConfig.avatar,t=>{this.avatarImage=t,this.getImageData()}),this.getImageData()}render(t){t.drawImage(this.templateCanvas,...this.position)}setAnimation({position:t,speed:i,rangeWidth:e}){this.position=t,this.speed=i,this.rangeWidth=e}checkEmployTrack(t){if("reversescroll"===this.globalConfig.type&&t>r)return!1;if("scroll"===this.globalConfig.type){const[i]=this.size;if(t<this.globalConfig.containerWidth-i-r)return!1}return!0}animation(){if(!this.position)return;const t=this.position[0]+this.speed[0],i=this.position[1]+this.speed[1];this.rangeWidth&&(this.rangeWidth[0]>t||this.rangeWidth[1]<t)?this.status=!1:(this.position=[t,i],this.employTrack&&(this.employTrack=this.checkEmployTrack(t)))}remove(){this.status=!1}}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s={};i.default=function(t,i,e){if(s[t])return void i(s[t]);const n=new Image;n.crossOrigin="",n.src=t,n.onload=()=>{s[t]=n,i(s[t])},n.onerror=e||function(){}}},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0});const s=12;class n{constructor(t,i){this.globalConfig=i,this.spriteConfig=t}calcSize(){const[t,i,e,n]=this.spriteConfig.padding;this.globalConfig.ctx.save(),this.globalConfig.ctx.font=`${this.spriteConfig.fontSize}px ${this.spriteConfig.fontFamily}`;const a=this.globalConfig.ctx.measureText(this.spriteConfig.content);this.globalConfig.ctx.restore();const o=this.spriteConfig.avatarSize+s+a.width+n+i,r=Math.max(this.spriteConfig.avatarSize,this.spriteConfig.fontSize)+t+e;return[Math.floor(o),r]}draw(t,i){const[,,e]=this.spriteConfig.padding,a=(i.size[1]-this.spriteConfig.avatarSize)/2;i.avatarImage&&"string"!=typeof i.avatarImage&&n.drawAvatar(t,{img:i.avatarImage,position:[e,a],imageHeight:this.spriteConfig.avatarSize,imageWidth:this.spriteConfig.avatarSize,radius:this.spriteConfig.radius});const o=(i.size[1]-this.spriteConfig.fontSize-5)/2;this.drawText(t,{left:this.spriteConfig.avatarSize+s+e,top:o}),n.drawBorder(t,i)}static drawBorder(t,i){const[e,s]=i.size;t.shadowOffsetX=3,t.shadowOffsetY=3,t.shadowBlur=12,t.shadowColor="rgba(46, 141, 239, 0.4)",t.strokeStyle="rgba(46, 141, 239, 1)",t.strokeRect(0,0,e,s)}static drawAvatar(t,i){const{img:e,imageWidth:s,imageHeight:n,position:a}=i;let{radius:o}=i;o=o>Math.max(s,n)/2?Math.max(n,s)/2:o;const[r,l]=a;if(t.save(),e){t.beginPath(),t.moveTo(r+o,l),t.lineTo(r+s-o,l),t.quadraticCurveTo(r+s,l,r+s,l+o),t.lineTo(r+s,l+n-o),t.quadraticCurveTo(r+s,l+n,r+s-o,l+n),t.lineTo(r+o,l+n),t.quadraticCurveTo(r,l+n,r,l+n-o),t.lineTo(r,l+o),t.quadraticCurveTo(r,l,r+o,l),t.closePath(),t.clip();const{width:i,height:a}=e;t.drawImage(e,0,0,i,a,r,l,s,n)}t.restore()}drawText(t,{left:i=0,top:e=0}){t.fillStyle=this.spriteConfig.fontColor,t.font=`${this.spriteConfig.fontSize}px ${this.spriteConfig.fontFamily}`,t.textAlign="left",t.textBaseline="top",t.fillText(this.spriteConfig.content,i,e)}}i.default=n},function(t,i,e){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.getRandomColor=()=>"rgb("+parseInt(String(255*Math.random()))+","+parseInt(String(255*Math.random()))+","+parseInt(String(255*Math.random()))+")",i.mixConfig=(t,i)=>(Object.keys(i).forEach(e=>{void 0===t[e]&&(t[e]=i[e])}),t)}]);
//# sourceMappingURL=danmu.js.map